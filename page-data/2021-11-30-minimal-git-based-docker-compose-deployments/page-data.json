{"componentChunkName":"component---src-templates-post-js","path":"/2021-11-30-minimal-git-based-docker-compose-deployments","result":{"data":{"markdownRemark":{"html":"<p>Deployment automation infrastructure is perhaps one the most crowded domains. Many of the options out there address key facets of the domain such as testing, QA approvals, pipeline transparency,\nrollback, zero-downtime rollouts, etc. There are also adjacent domains such as the DevOps space with tools like Puppet and Ansible.</p>\n<p>Those tools are great when you need them, but sometimes they introduce more complexity cost than they're worth.</p>\n<p>This recipe shows how to set up a minimal repository that will clone itself and run docker-compose on new pushes. It doesn't do a lot of the things those full-featured deployment tools do,\nbut it is pretty impressive what you <em>can</em> get with a tiny git hook and a script in the right place.</p>\n<p><em><strong>Note:</strong> The pattern of calling a script in a repository from a git hook is a bit of a security risk in multi-user environments if write access on the repository are set too permissively. Please exercise caution.</em></p>\n<h2 id=\"prerequisites\" style=\"position:relative;\"><a href=\"#prerequisites\" aria-label=\"prerequisites permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prerequisites</h2>\n<p><em>If you're here, I'm going to assume you already know how to set up SSH and are confident enough to customize this recipe for your needs.</em></p>\n<h3 id=\"both-target-and-development-hosts\" style=\"position:relative;\"><a href=\"#both-target-and-development-hosts\" aria-label=\"both target and development hosts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Both Target and Development Hosts</h3>\n<ul>\n<li><code class=\"language-text\">git</code></li>\n</ul>\n<h3 id=\"target-host\" style=\"position:relative;\"><a href=\"#target-host\" aria-label=\"target host permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Target Host</h3>\n<ul>\n<li><code class=\"language-text\">docker</code></li>\n<li><code class=\"language-text\">docker-compose</code></li>\n</ul>\n<h2 id=\"server-repository-setup-on-target-host\" style=\"position:relative;\"><a href=\"#server-repository-setup-on-target-host\" aria-label=\"server repository setup on target host permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Server Repository Setup (on Target Host)</h2>\n<p>First we'll create a <a href=\"https://git-scm.com/book/en/v2/Git-on-the-Server-Getting-Git-on-a-Server\">bare repository</a> on the server - feel free to replace \"myproject\" with another name (It probably can't have spaces, but I haven't tested that.);</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">ssh myuser@myserver\ngit init --bare /home/myuser/myproject.git</code></pre></div>\n<p>Next we'll install the git hook in that bare repository;</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">echo &#39;[ -d &quot;/home/myuser/myproject&quot; ] &amp;&amp; /home/myuser/myproject/deploy.sh || git clone /home/myuser/myproject.git /home/myuser/myproject &amp;&amp; /home/myuser/myproject/deploy.sh&#39; &gt; /home/myuser/myproject.git/hooks/post-receive &amp;&amp; chmod +x /home/myuser/myproject.git/hooks/post-receive</code></pre></div>\n<p>At this point, the repository can be pushed to and it will automatically clone itself and execute a <code class=\"language-text\">deploy.sh</code> script that must be placed at the root of the repository.</p>\n<h2 id=\"client-repository-setup\" style=\"position:relative;\"><a href=\"#client-repository-setup\" aria-label=\"client repository setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Client Repository Setup</h2>\n<p>Clone the repository and cd into it;</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">git clone myuser@myserver:/home/myuser/myproject.git myproject\ncd myproject</code></pre></div>\n<p>Create the <code class=\"language-text\">deploy.sh</code> file with the following contents;</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">#!/bin/bash\nset -e\n\ncd /home/myuser/myproject\n\nSTAGE=&quot;$1&quot;\n\nif [ &quot;$STAGE&quot; == &quot;plan&quot; ]; then\n    ./deploy.sh execute\n    exit 0;\nfi\n\nif [ &quot;$STAGE&quot; == &quot;execute&quot; ]; then\n    docker-compose up -d --build --remove-orphans\n    exit 0;\nfi\n\necho pwd=`pwd`\necho GIT_DIR=${GIT_DIR}\nunset GIT_DIR\ngit pull\n./deploy.sh plan</code></pre></div>\n<p>Create the <code class=\"language-text\">docker-compose.yml</code> file with the following contents;</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">version: &#39;3.7&#39;\nservices:\n\n  hello-world:\n    image: armhf/hello-world</code></pre></div>\n<p>Mark the <code class=\"language-text\">deploy.sh</code> script as executable and commit/push the initial change;</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">chmod +x deploy.sh \ngit add -A\ngit commit -m &quot;Initial commit&quot;</code></pre></div>\n<p>You should then see something like this;</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ git commit -m &quot;Initial commit&quot;\n[master (root-commit) f90ae92] Initial commit\n 2 files changed, 28 insertions(+)\n create mode 100755 deploy.sh\n create mode 100644 docker-compose.yml\n$ git push\nEnumerating objects: 4, done.\nCounting objects: 100% (4/4), done.\nDelta compression using up to 12 threads\nCompressing objects: 100% (4/4), done.\nWriting objects: 100% (4/4), 530 bytes | 530.00 KiB/s, done.\nTotal 4 (delta 0), reused 0 (delta 0), pack-reused 0\nremote: Cloning into &#39;/home/myuser/myproject&#39;...\nremote: done.\nremote: pwd=/home/myuser/myproject\nremote: GIT_DIR=.\nremote: Already up to date.\nremote: Creating network &quot;myproject_default&quot; with the default driver\nremote: Pulling hello-world (armhf/hello-world:)...\nremote: latest: Pulling from armhf/hello-world\nremote: Digest: sha256:9701edc932223a66e49dd6c894a11db8c2cf4eccd1414f1ec105a623bf16b426\nremote: Status: Downloaded newer image for armhf/hello-world:latest\nremote: Creating myproject_hello-world_1 ... \nremote: Creating myproject_hello-world_1 ... done\nTo myserver:/home/myuser/myproject.git\n * [new branch]      master -&gt; master</code></pre></div>\n<p>Congratulations, you've now bootstrapped some minimal git-based deployment infrastructure. Use it wisely and build something cool!</p>\n<h2 id=\"related-work\" style=\"position:relative;\"><a href=\"#related-work\" aria-label=\"related work permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Related Work</h2>\n<ul>\n<li><a href=\"https://kenfavors.com/code/using-git-to-deploy-code/\">https://kenfavors.com/code/using-git-to-deploy-code/</a></li>\n<li><a href=\"https://ricardoanderegg.com/posts/git-push-deployments-docker-tags/\">https://ricardoanderegg.com/posts/git-push-deployments-docker-tags/</a></li>\n</ul>","timeToRead":3,"excerpt":"Deployment automation infrastructure is perhaps one the most crowded domains. Many of the options out there address key facets of the domain…","frontmatter":{"title":"Minimal git-based docker-compose deployments","cover":null,"date":"2021-11-30T00:00:00.000Z","categories":["Tutorials"],"tags":["Operational Excellence","Software Engineering"]},"fields":{"slug":"/2021-11-30-minimal-git-based-docker-compose-deployments","date":"November 30, 2021"}}},"pageContext":{"slug":"/2021-11-30-minimal-git-based-docker-compose-deployments","nexttitle":"Off-grid lead acid battery charging","nextslug":"/2021-11-29-off-grid-lead-acid-battery-charging","prevtitle":"EPever MPPT Solar Charge Controller Monitoring Hardware","prevslug":"/2020-10-27-epever-esp-8266-controller"}},"staticQueryHashes":["3969716136"]}